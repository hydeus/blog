<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0
    }

    #container {
      width: 500px;
      margin: 50px auto 0 auto;
      position: relative;
    }

    #warp {
      width: 500px;
      border: 1px solid #ccc;
      border-bottom: 0;
      border-left: 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }

    .item {
      /* width: 20px; */
      flex: 0 1 4.16666666%;
      height: 30px;
      border: 1px solid #ccc;
      border-right: 0;
      border-top: 0;
      box-sizing: border-box;
    }

    #mask {
      background-color: #40a9ff;
      opacity: .5;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="warp">
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
      <div class="item"></div>
    </div>
    <div id="mask"></div>
  </div>
  <script type="text/javascript">
    var itemArr = document.getElementsByClassName("item");
    var items = Array.from(itemArr).map(item => {
      var { x, y, width, height } = item.getBoundingClientRect();
      return { x, y, width, height }
    });
    var maskEle = document.getElementById("mask");
    var ele = document.getElementById("warp");
    var { x: eleX, y: eleY, width: eleWidth, height: eleHeight } = ele.getBoundingClientRect();

    ele.onmousedown = function({ x: startX, y: startY }) {
      // IE8 取消默认行为-设置全局捕获
      // if(ele.setCapture) {
      //   ele.setCapture();
      // }
      var endX, endY, disX, disY;

      document.onmousemove = function({ x, y }) {
        endX = x;
        endY = y;
        var realX, // 横向实际允许拖动的最大值
            realY, // 纵向实际允许拖动的最大值
            left = startX - eleX, // 阴影部分的left
            top = startY - eleY; // 阴影部分的right
            disX = endX - startX;
            disY = endY - startY;

        // 从左到右
        if (disX > 0) {
          endX = startX;
          realX = eleX + eleWidth - startX;

          if (Math.abs(disX) > realX) {
            disX = realX;
          }
        }

        // 从右到左
        if (disX < 0) {
          realX = startX - eleX;

          if (endX < eleX) endX = eleX;

          if (Math.abs(disX) > realX) {
            disX = realX;
            left = 0;
          } else {
            left = endX - eleX;
          }
        }

        // 从上到下
        if (disY > 0) {
          endY = startY;
          realY = eleY + eleHeight - startY;

          if (Math.abs(disY) > realY) {
            disY = realY;
          }
        }

        // 从下到上
        if (disY < 0) {
          realY = startY - eleY;

          if (endY < eleY) endY = eleY;

          if (Math.abs(disY) > realY) {
            disY = realY;
            top = 0;
          } else {
            top = endY - eleY;
          }
        }

        maskEle.style.left = left + 'px';
        maskEle.style.top = top + 'px';
        maskEle.style.width = Math.abs(disX) + 'px';
        maskEle.style.height = Math.abs(disY) + 'px';
      }

      document.onmouseup = function() {
        document.onmousemove = null;
        document.onmouseup = null;
        // 释放全局捕获
        // if(ele.releaseCapture) {
        //   ele.releaseCapture();
        // }

        // reset ele
        // maskEle.style.left = 0;
        // maskEle.style.top = 0;
        // maskEle.style.width = 0;
        // maskEle.style.height = 0;
        

        console.log(`eleX: ${eleX}, eleY: ${eleY}, width: ${Math.abs(eleWidth)}, height: ${Math.abs(eleHeight)}`);
        console.log(`endX: ${endX}, endY: ${endY}, width: ${Math.abs(disX)}, height: ${Math.abs(disY)}`);

        filterItemInArea(endX, endY, Math.abs(disX), Math.abs(disY));
      }

      return false;
    }

    /**
      判断某个点是否在矩形内
      x1, y1 是矩形左上角的坐标
      x2, y2 是矩形右下角的坐标
      x, y 是待检测的坐标
    */
    function isInside(x1, y1, x2, y2, x, y) {
      if (x < x1) return false;
      if (x > x2) return false;
      if (y < y1) return false;
      if (y > y2) return false;
      return true;
    }

    function filterItemInArea(x, y, width, height) {
      var leftX = x,
          leftY = y,
          rightX = x + width,
          rightY = y + height;
      var inArea = items.map((item, index) => {
        console.log(index, isInside(leftX, leftY, rightX, rightY, item.x, item.y), isInside(leftX, leftY, rightX, rightY, item.x, item.y + item.height), isInside(leftX, leftY, rightX, rightY, item.x + item.width, item.y), isInside(leftX, leftY, rightX, rightY, item.x + item.width, item.y + item.height));
        if (isInside(leftX, leftY, rightX, rightY, item.x, item.y)
          || isInside(leftX, leftY, rightX, rightY, item.x, item.y + item.height)
          || isInside(leftX, leftY, rightX, rightY, item.x + item.width, item.y)
          || isInside(leftX, leftY, rightX, rightY, item.x + item.width, item.y + item.height)
        ) {
          return {...item, select: true}
        }
        return {...item, select: false}
      });

      console.log(inArea.filter(item => item.select).length);
    }
  </script>
</body>

</html>